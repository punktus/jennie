<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jennie</title>

    <!--<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300&display=swap" rel="stylesheet">-->

    <style>
        :root {
            --color1: #FFD166;
            --color2: #06D6A0;
            --color3: #118AB2;
            --color4: #073B4C;
            --main-color: #EF476F;
            --text-color: #fff;

            /* CSS HEX */
            --imperial-red: #f94144ff;
            --orange-crayola: #f3722cff;
            --carrot-orange: #f8961eff;
            --coral: #f9844aff;
            --saffron: #f9c74fff;
            --pistachio: #90be6dff;
            --zomp: #43aa8bff;
            --dark-cyan: #4d908eff;
            --paynes-gray: #577590ff;
            --cerulean: #277da1ff;
            
            /* CSS HSL */
            --imperial-red: hsla(359, 94%, 62%, 1);
            --orange-crayola: hsla(21, 89%, 56%, 1);
            --carrot-orange: hsla(33, 94%, 55%, 1);
            --coral: hsla(20, 94%, 63%, 1);
            --saffron: hsla(42, 93%, 64%, 1);
            --pistachio: hsla(94, 38%, 59%, 1);
            --zomp: hsla(162, 43%, 46%, 1);
            --dark-cyan: hsla(178, 30%, 43%, 1);
            --paynes-gray: hsla(208, 25%, 45%, 1);
            --cerulean: hsla(198, 61%, 39%, 1);
        }

        body {
            /*font-family: 'Titillium Web', sans-serif;*/
            font-family: sans-serif;
            background-color: var(--dark-cyan);
            color: var(--text-color);
            padding: 2em 3em;
            font-size: 16px;
            line-height: 24px;
        }
        select, input, button {
            padding: 4px 10px;
            border: none;
        }

        table {
            width: 100%;
            background-color: var(--paynes-gray);
            border-collapse: collapse;
        }

        td, th {
            padding: 10px;
        }

        th {
            text-transform: capitalize;
            text-align: left;
            border-bottom: 1px solid;
        }

        tbody tr:nth-child(even) {
            background-color: var(--cerulean);
        }

        tbody tr:hover {
            background-color: var(--zomp);
        }

        tfoot td {
            border-top: 1px solid;
        }

        .footer {
            position: absolute;
            bottom: 1em;
            left: 1em;
            z-index: 10;
        }
    </style>
</head>

<body>
    <header>
        <h1 id="page-title"></h1>
    </header>
    <main id="main"></main>
    <footer id="footer" class="footer"></footer>

    <script>

        // --- VARIABLES ---
        const app = {
            settings: {},
            data: [],
            systems: [],
            structure: []
        };

        // --- ELEMENTS --
        const pageTitleEl = document.getElementById('page-title');
        const mainEl = document.getElementById('main');
        const footerEl = document.getElementById('footer');

        // Render table from data
        function generateTable() {

            let thead = '';            
            let tbody = '';
            let tfoot = '';


            // thead
            let ths = '';

            // data
            for (let key of Object.keys(app.data[0])) {
                ths += `<th>${key}</th>`; 
            }

            // System
            for (let system of app.systems) {
                ths += `<th>${system.name}</th>`; 
            }

            ths += `<th>${app.settings.txt.save}</th>`; 
            thead += `<thead><tr>${ths}</tr></thead>`;




            // tbody
            for (let element of app.data) {

                tbody += renderRow(element);

                //let tds = '';

                //// data
                //for (key in element) {
                //    tds += `<td><input type="text" data-org-value="${element[key]}" value="${element[key]}" /></td>`;
                //}

                //// system
                //for (let system of app.systems) {
                //    let options = '';

                //    //
                //    for (let option of system.values) {
                //        options += `<option>${option}</option>`;
                //    }

                //    tds += `<td><select data-org-value="${system.values[0]}">${options}</select></td>`;
                //}

                //tds += `<td><button class="update-btn" disabled>${app.settings.txt.update}</button</td>`;
                //tbody += `<tr data-id="${element.id}">${tds}</tr>`;
            }





            // tfoot
            const colspan = Object.keys(app.data[0]).length + app.systems.length + 1;
            tfoot += `<tfoot><tr><td colspan="${colspan}"><button class="add-btn">${app.settings.txt.add}</button></td></tr></tfoot>`;


            // Update html
            mainEl.innerHTML = `<table>${thead}<tbody>${tbody}</tbody>${tfoot}</table>`;
        }

        //
        function renderRow(element) {
            let tds = '';

            // data
            for (key in element) {
                tds += `<td><input type="text" data-org-value="${element[key]}" value="${element[key]}" /></td>`;
            }

            // system
            for (let system of app.systems) {
                let options = '';

                //
                for (let option of system.values) {
                    options += `<option>${option}</option>`;
                }

                //
                tds += `<td><select data-org-value="${system.values[0]}">${options}</select></td>`;
            }

            //
            tds += `<td><button class="update-btn" disabled>${app.settings.txt.update}</button</td>`;

            //
            return `<tr data-id="${element.id}">${tds}</tr>`;
        }

        // Render page header & footer texts
        function setTexts() {
            pageTitleEl.innerHTML = app.settings.txt.pageTitle;
            footerEl.innerHTML = app.settings.txt.footerText;
        }

        //
        const fetchData = async () => {
            try {

                const responsesJSON = await Promise.all([
                    fetch('settings.json', { headers: { 'Accept': 'application/json' } }),
                    fetch('data.json', { headers: { 'Accept': 'application/json' } }),
                    fetch('systems.json', { headers: { 'Accept': 'application/json' } }),
                    fetch('structure.json', { headers: { 'Accept': 'application/json' } })
                ]);

                const [settingsRes, dataRes, systemsRes, structureRes] = await Promise.all(responsesJSON.map(r => r.json()));

                app.settings = settingsRes;
                app.data = dataRes;
                app.systems = systemsRes;
                app.structure = structureRes;

                setTexts();
                generateTable();
                
            } catch (err) {
                throw err;
            }
        };

        //
        fetchData();

        document.addEventListener("change", function (e) {
            if (e.target) {
                console.log(e.target, e.target.dataset.orgValue, e.target.value, e.target.closest('tr'));

                if (e.target.dataset.orgValue !== e.target.value) {
                    const row = e.target.closest('tr');
                    const id = row.dataset.id;
                    console.log('update row ', e.target.value, id);
                }
            }            
        });

    </script>
</body>
</html>